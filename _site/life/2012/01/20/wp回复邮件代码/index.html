<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      wp回复邮件代码 &middot; LeoPan
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>小屋如舟衾似沙<br>灵芝劫尽枕芦花<br>杜宇声声归何处<br>群玉山头第一家<br></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/archives/">Archives</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about-me/">About me</a>
        
      
    
      
    
      
    
      
    
      
    

<!--     <a class="sidebar-nav-item" href="/archive/v.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    <span class="sidebar-nav-item">Currently v</span> -->
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2014. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <label for="sidebar-checkbox" class="sidebar-toggle"></label>

          <h3 class="masthead-title">
            <a href="/" title="Home">LeoPan</a>
            <small>人生就是不断的做选择题</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">wp回复邮件代码</h1>
  <span class="post-date">20 Jan 2012</span>
  <p>很久没有折腾wordpress了
昨天在读<a href="http://xavierskip.sinaapp.com/?p=303">《什么是墙为什么要翻墙以及怎么翻墙》</a>这篇文章的时候，发现他的主题挺好看的，于是找到了一个不错的UI设计师的站点：<a href="http://xuui.net">xu Design</a>，一个不错的站点，当然好看的东西总是要收费的，很多时候拿钱去换一些别人付出辛劳汗水的作品是无可厚非的。当然这个主题是免费的，我又无耻的做了一回伸手党。<br/>
\n\n
好像在上次升级之后之前用的回复评论邮件的插件失效了，虽然本博没有什么留言，但是人要追求的总是更好的，于是决定用另外一种方法去实现回复邮件的代码，代码网上搜了一箩筐，但是部分博客中的文章总是把别人的代码复制过来，上面还写着只需将代码复制进主题中即可，但是亲身试过之后才知道，直接复制根本无法实现功能，反而导致了访问博客时网页中什么都无法显示，当然代码基本上是对的，唯一出现的问题是，复制下来的代码中往往该是英文的单引号的地方是中文的单引号，在我人品还不算差的时候，只能说明这些是博主们的错误，当然很多时候一些站点无非是为了赚取访问量+广告点击率。</p>

<p>废话不说了，代码加在function.php代码中：
[code lang="php"]add_action('comment_post', 'comment_mail_notify');
function comment_mail_notify($comment_id) {
    $admin_notify = '0';
        // admin 要不要收回覆通知 ( '1'=要 ; '0'=不要 )，显然这里是最好为0，要不然自己别人在回复自己评论时会出现2封邮件
    $admin_email = get_bloginfo ('admin_email');
        // $admin_email 可改為你指定的 e-mail.
    $comment = get_comment($comment_id);
    $comment_author_email = trim($comment->comment_author_email);
    $parent_id = $comment->comment_parent ? $comment->comment_parent :”;
    global $wpdb;
    if ($wpdb->query("Describe {$wpdb->comments} comment_mail_notify") == ”)
        $wpdb->query("ALTER TABLE {$wpdb->comments} ADD COLUMN comment_mail_notify TINYINT NOT NULL DEFAULT 0;");
    if (($comment_author_email != $admin_email &amp;&amp; isset($<em>POST['comment_mail_notify']))
                || ($comment_author_email== $admin_email &amp;&amp; $admin_notify == '1'))
        $wpdb->query("UPDATE {$wpdb->comments} SET comment_mail_notify='1' WHERE comment_ID='$comment_id'");
        $notify = $parent_id ? get_comment($parent_id)->comment_mail_notify : '0';
        $spam_confirmed = $comment->comment_approved;
    if ($parent_id != ” &amp;&amp; $spam_confirmed != 'spam' &amp;&amp; $notify == '1') {
        $wp_email = 'Leo' . preg_replace('#^www.#', ”, strtolower($</em>SERVER['SERVER_NAME']));
                // LEO改为你的即可
        $to = trim(get_comment($parent_id)->comment_author_email);
        $subject = '您在 [' . get_option("blogname") . '] 的回复有了回应';
        $message = '
            <div style="background-color:#eef2fa; border:1px solid #d8e3e8; color:#111; padding:0 15px; -moz-border-radius:5px; -webkit-border-radius:5px; -khtml-border-radius:5px;">
            <p>' . trim(get_comment($parent_id)->comment_author) . ', 您好!</p>
            <p>您曾在《' . get_the_title($comment->comment_post_ID) . '》的留言:<br />
            ' . trim(get_comment($parent_id)->comment_content) . '</p>
            <p>' . trim($comment->comment_author) . ' 給您的回应:<br />
            ' . trim($comment->comment_content) . '<br /></p>
            <p>您可以点击 <a href="' . htmlspecialchars(get_comment_link($parent_id)) . '">查看回应完整內容</a></p>
            <p>欢迎再度光临本博客 <a href="' . get_option('home') . '">' . get_option('blogname') . '</a></p>
            <p>(此邮件为系统自动发送，请勿回复.)</p>
            </div>';
            $from = "From: \"" . get_option('blogname') . "\" &lt;$wp_email>";
            $headers = "$from\nContent-Type: text/html; charset=" . get_option('blog_charset') . "\n";
            wp_mail( $to, $subject, $message, $headers );
//echo 'mail to ', $to, '<br/> ' , $subject, $message; // for testing
}
}</p>

<p>/<em> 自动加勾选栏 </em>/
function add_checkbox() {</p>

<pre><code>echo '&lt;input type="checkbox" name="comment_mail_notify" id="comment_mail_notify" value="comment_mail_notify" checked="checked" style="margin-left:20px;" /&gt;&lt;label for="comment_mail_notify"&gt;有人回复是邮件通知我&lt;/label&gt;';
</code></pre>

<p>}
add_action('comment_form', 'add_checkbox'); [/code]
PS:代码源自网络</p>

<p>这边有个小问题是在自己回复别人评论的时候，页面上也会出现“有人回复是邮件通知我”这个勾选栏，看着比较烦就自己把它改掉了：
[code lang="php"]
function add_checkbox() {
$current_user = wp_get_current_user();
if ( 0 == $current_user->ID||'leopure110@gmail.com'!=$current_user->user_email ) {//没有登录
    echo '<input type="checkbox" name="comment_mail_notify" id="comment_mail_notify" value="comment_mail_notify" checked="checked" style="margin-left:20px;" />
   <label for="comment_mail_notify">有人回复是邮件通知我</label>';
}</p>

<p>}</p>

<p>[/code]</p>

<p>&lt;全文完></p>

</div>
 <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'leopanme'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
<!-- <div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/life/2014/01/23/%E5%88%92%E8%AF%8D%E6%90%9C%E7%B4%A2%E8%B1%86%E7%93%A3%E7%94%B5%E5%BD%B1/">
            划词搜索豆瓣电影
            <small>23 Jan 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/design%20pattern/2013/09/08/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0%E2%80%94%E2%80%94%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F,%E5%A4%96%E8%A7%82%E5%B1%82%E6%A8%A1%E5%BC%8F,%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/">
            设计模式简单学习——适配器模式,外观层模式,代理模式
            <small>08 Sep 2013</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/design%20pattern/2013/09/08/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0%E2%80%94%E2%80%94%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/">
            设计模式简单学习——单例模式
            <small>08 Sep 2013</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div> -->

      </div>
    </div>

  </body>
</html>
